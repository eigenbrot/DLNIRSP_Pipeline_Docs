
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>DLNIRSP_Pipeline.IFUCalibration &#8212; DLNIRSP_Pipeline v0.6.1</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700" type="text/css" />
    <link rel="stylesheet" href="../../_static/dkist.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favico.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="col-md-3 navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://nso.edu"><img src="../../_static/img/NSOlogo.gif">
        </a>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav hidden">
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">DL-NIRSP Pipeline Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_file.html">Configuration File Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../walkthrough.html">Data Reduction Walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../API.html">Reference/API</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>
          
            <ul class="nav navbar-nav navbar-left">
              <li><a href="http://dkist.nso.edu/">DKIST</a></li>
              <li><a href="http://docs.cadair.com/devdocs">DC Developer Guide</a></li>
              <li><a href="http://docs.cadair.com/datarate">DKIST Data Rate</a></li>
              <li><a href="http://docs.cadair.com/datamodel">DKIST Data Model</a></li>
            </ul>
          
          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          

        </div>
    </div>
  </div>

<div class="container">
  <div class="row">

    <div class="col-md-3"><div id="side-logo" >
            <a href="http://dkist.nso.edu">
                <img src="../../_static/img/DKISTLogo-Medium.jpg">
            </a>
        </div><div id="sidebar" class="bs-sidenav" role="complementary">
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">DL-NIRSP Pipeline Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_file.html">Configuration File Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../walkthrough.html">Data Reduction Walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../API.html">Reference/API</a></li>
</ul>

            
        </div>
    </div>

    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for DLNIRSP_Pipeline.IFUCalibration</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">asdf</span>
<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">spo</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span> <span class="k">as</span> <span class="n">pyfits</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pgf</span> <span class="k">import</span> <span class="n">PdfPages</span> <span class="k">as</span> <span class="n">PDF</span>
<span class="kn">from</span> <span class="nn">DLNIRSP_Pipeline</span> <span class="k">import</span> <span class="n">Data</span><span class="p">,</span> <span class="n">generic</span>
<span class="kn">from</span> <span class="nn">DLNIRSP_Pipeline.tag</span> <span class="k">import</span> <span class="n">tag</span>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../api/DLNIRSP_Pipeline.IFUCalibration.main.html#DLNIRSP_Pipeline.IFUCalibration.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">knifedir</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">dark_cal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gain_cal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">geo_cal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_no_geo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reduce and analyze a set of knife-edge scan images to determine the mapping from slit position to IFU position</span>

<span class="sd">    TWO knife-edge scans are needed; one in the X direction and one in the Y direction. The data for these scans should</span>
<span class="sd">    live in the same directory; they are identified via the ID___004 header keyword.</span>

<span class="sd">    The steps are (for each scan direction):</span>

<span class="sd">    1. Subtract dark and divide by flat (basic reduction)</span>

<span class="sd">    2. Apply the geometric correction</span>

<span class="sd">    3. Compute the mapping from slit location to real IFU location</span>

<span class="sd">    At the end the full 2D location of each slit position is known.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    knifedir : str</span>
<span class="sd">        Directory containing both X and Y knife scans</span>

<span class="sd">    output : str</span>
<span class="sd">        Location of ASDF file used to store the final IFU Calibration</span>

<span class="sd">    dark_cal : `Data.FitsData`</span>
<span class="sd">        Dark Calibration object</span>

<span class="sd">    gain_cal : `Data.FitsData`</span>
<span class="sd">        Flat Calibration object</span>

<span class="sd">    geo_cal : dict</span>
<span class="sd">        Geometric Calibration object. Should really be the same one used for your Science data</span>

<span class="sd">    allow_no_geo : bool</span>
<span class="sd">        Set to True to allow this IFU Calibration pipeline to run without a `geo_cal` object. I have no idea why you</span>
<span class="sd">        would want to do this.</span>

<span class="sd">    threads : int</span>
<span class="sd">        The number of cpu threads used for basic and geometric reductions. Use a lot.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing the real FOV positions for the x and y dimensions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cal_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;xknife&#39;</span><span class="p">,</span> <span class="s1">&#39;yknife&#39;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: Starting analysis of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">(),</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
        <span class="n">fitsData</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">knife_save_dir</span> <span class="o">=</span> <span class="s1">&#39;knife_proc&#39;</span>
        <span class="n">geo_dir</span> <span class="o">=</span> <span class="n">knife_save_dir</span> <span class="o">+</span> <span class="s1">&#39;/geo&#39;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_geo_done&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geo_dir</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: found previously corrected knife images in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">(),</span> <span class="n">knife_save_dir</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: loading data in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">(),</span> <span class="n">geo_dir</span><span class="p">))</span>
            <span class="n">fitsData</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">AlignmentData</span><span class="p">(</span><span class="n">geo_dir</span><span class="p">,</span> <span class="n">dataset_ID</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dark_cal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">gain_cal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">basic_dir</span> <span class="o">=</span> <span class="n">knife_save_dir</span> <span class="o">+</span> <span class="s1">&#39;/basic&#39;</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">basic_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_basic_done&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basic_dir</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: doing Dark and/or Gain corrections&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">()))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: loading data in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">(),</span> <span class="n">knifedir</span><span class="p">))</span>
                    <span class="n">fitsData</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">AlignmentData</span><span class="p">(</span><span class="n">knifedir</span><span class="p">,</span> <span class="n">dataset_ID</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
                    <span class="n">correct_knife_basic</span><span class="p">(</span><span class="n">fitsData</span><span class="p">,</span> <span class="n">dark_cal</span><span class="p">,</span> <span class="n">gain_cal</span><span class="p">,</span> <span class="n">basic_dir</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: found previously dark/gain reduced images in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">(),</span> <span class="n">basic_dir</span><span class="p">))</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: loading data in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">(),</span> <span class="n">basic_dir</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">fitsData</span>
                <span class="n">fitsData</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">AlignmentData</span><span class="p">(</span><span class="n">basic_dir</span><span class="p">,</span> <span class="n">dataset_ID</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">geo_cal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">geo_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: doing Geometric Correction&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">()))</span>
                <span class="n">correct_knife_geo</span><span class="p">(</span><span class="n">fitsData</span><span class="p">,</span> <span class="n">geo_cal</span><span class="p">,</span> <span class="n">geo_dir</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: loading data in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">(),</span> <span class="n">geo_dir</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">fitsData</span>
                <span class="n">fitsData</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">AlignmentData</span><span class="p">(</span><span class="n">geo_dir</span><span class="p">,</span> <span class="n">dataset_ID</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="n">allow_no_geo</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No Geometric Calibration provided. Set allow_no_geo=True if you really want to do this&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: finding peaks in light-curve derivatives&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">()))</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">find_positions</span><span class="p">(</span><span class="n">fitsData</span><span class="p">)</span>

        <span class="n">cal_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
                          <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fitsData</span><span class="o">.</span><span class="n">data_hdus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)}</span>

        <span class="k">del</span> <span class="n">fitsData</span>

    <span class="n">ifu_calibration</span> <span class="o">=</span> <span class="n">generate_ifu_calibration</span><span class="p">(</span><span class="n">cal_dict</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ifu_calibration</span></div>

<div class="viewcode-block" id="generate_ifu_calibration"><a class="viewcode-back" href="../../api/DLNIRSP_Pipeline.IFUCalibration.generate_ifu_calibration.html#DLNIRSP_Pipeline.IFUCalibration.generate_ifu_calibration">[docs]</a><span class="k">def</span> <span class="nf">generate_ifu_calibration</span><span class="p">(</span><span class="n">cal_dict</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Just write the dictionary to an ASDF file&quot;&quot;&quot;</span>

    <span class="n">asdf_out</span> <span class="o">=</span> <span class="n">asdf</span><span class="o">.</span><span class="n">AsdfFile</span><span class="p">(</span><span class="n">cal_dict</span><span class="p">)</span>
    <span class="n">asdf_out</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cal_dict</span></div>

<div class="viewcode-block" id="correct_knife_basic"><a class="viewcode-back" href="../../api/DLNIRSP_Pipeline.IFUCalibration.correct_knife_basic.html#DLNIRSP_Pipeline.IFUCalibration.correct_knife_basic">[docs]</a><span class="k">def</span> <span class="nf">correct_knife_basic</span><span class="p">(</span><span class="n">fitsData</span><span class="p">,</span> <span class="n">dark_cal</span><span class="p">,</span> <span class="n">gain_cal</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do &quot;basic&quot; reductions (dark and flat) on a set of knife-edge scan images</span>

<span class="sd">    This function just manages the parallelization of the reduction. See `basic_helper` for the meat of the script.</span>
<span class="sd">    The individual reduced images are saved to disk because the knife datasets are often too large to keep and move</span>
<span class="sd">    around in memory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsData : `Data.FitsData`</span>
<span class="sd">        Object with each knife image to be corrected in a separate data_hdu</span>

<span class="sd">    dark_cal : `Data.FitsData`</span>
<span class="sd">        Dark Calibration object</span>

<span class="sd">    gain_cal : `Data.FitsData`</span>
<span class="sd">        Gain Calibration object</span>

<span class="sd">    save_dir : str</span>
<span class="sd">        Directory in which to save the reduced images. Each will have a file name of SAVE_DIR/dg_ORIGINALNAME</span>

<span class="sd">    threads : int</span>
<span class="sd">        The number of cpu threads to use. This is an embarassingly parallizable problem, so throw as much as you want</span>
<span class="sd">        at it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dark_data</span> <span class="o">=</span> <span class="n">dark_cal</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">dark_data</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gain_data</span> <span class="o">=</span> <span class="n">gain_cal</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Stokes I</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">gain_data</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fitsData</span><span class="o">.</span><span class="n">file_list</span><span class="p">,</span>
               <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">dark_data</span><span class="p">),</span>
               <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">gain_data</span><span class="p">),</span>
               <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">save_dir</span><span class="p">))</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">basic_helper</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="c1"># Save file showing that the (lengthy) corrections have been applied</span>
    <span class="n">knife_type</span> <span class="o">=</span> <span class="n">fitsData</span><span class="o">.</span><span class="n">dataset_ID</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_basic_done&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">knife_type</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Basic corrections applied on </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()))</span></div>

<div class="viewcode-block" id="basic_helper"><a class="viewcode-back" href="../../api/DLNIRSP_Pipeline.IFUCalibration.basic_helper.html#DLNIRSP_Pipeline.IFUCalibration.basic_helper">[docs]</a><span class="k">def</span> <span class="nf">basic_helper</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subtract the dark then divide by the gain. Finally, save the reduced file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : str</span>
<span class="sd">        Filename of the raw data</span>

<span class="sd">    d : `numpy.ndarray`</span>
<span class="sd">        Dark image</span>

<span class="sd">    g : `numpy.ndarray`</span>
<span class="sd">        Flat image</span>

<span class="sd">    save_dir : dir</span>
<span class="sd">        Directory into which to save the reduced image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/dg_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> -&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">(),</span> <span class="n">f</span><span class="p">,</span> <span class="n">new_name</span><span class="p">))</span>
    <span class="n">hdl</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">hdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">hdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">d</span>
    <span class="n">hdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">hdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">g</span>
    <span class="n">hdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">hdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">hdl</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">hdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">del</span> <span class="n">hdl</span></div>

<div class="viewcode-block" id="correct_knife_geo"><a class="viewcode-back" href="../../api/DLNIRSP_Pipeline.IFUCalibration.correct_knife_geo.html#DLNIRSP_Pipeline.IFUCalibration.correct_knife_geo">[docs]</a><span class="k">def</span> <span class="nf">correct_knife_geo</span><span class="p">(</span><span class="n">fitsData</span><span class="p">,</span> <span class="n">geometric_calibration</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply geometric corrections to a set of knife-edge scan data.</span>

<span class="sd">    This function just manages the parallelization of the reduction. See `geo_helper` for the meat of the script.</span>
<span class="sd">    The individual reduced images are saved to disk because the knife datasets are often too large to keep and move</span>
<span class="sd">    around in memory.</span>

<span class="sd">    You probably should run this on data that have already had basic reductions applied (`correct_knife_basic`), but</span>
<span class="sd">    that&#39;s not strictly necessary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsData : `Data.FitsData`</span>
<span class="sd">        Object with each knife image to be corrected in a separate data_hdu</span>

<span class="sd">    geometric_calibration : dict</span>
<span class="sd">        A dictionary of the Geometric Calibration parameters</span>

<span class="sd">    outdir : str</span>
<span class="sd">        Directory in which to save the corrected data</span>

<span class="sd">    threads : int</span>
<span class="sd">        Number of cpu threads to use for the reduction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">knife_type</span> <span class="o">=</span> <span class="n">fitsData</span><span class="o">.</span><span class="n">dataset_ID</span>

    <span class="c1"># We do this dictionary/numpy conversion because some of ASDF&#39;s stupid internal data-types aren&#39;t pickle-able</span>
    <span class="c1">#  and therefore don&#39;t play nice with MultiProcessing</span>
    <span class="n">geo_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ANGLES&#39;</span><span class="p">:</span> <span class="n">geometric_calibration</span><span class="p">[</span><span class="s1">&#39;ANGLES&#39;</span><span class="p">],</span>
                <span class="s1">&#39;BEAMOFF&#39;</span><span class="p">:</span> <span class="n">geometric_calibration</span><span class="p">[</span><span class="s1">&#39;BEAMOFF&#39;</span><span class="p">],</span>
                <span class="s1">&#39;BORDERS&#39;</span><span class="p">:</span> <span class="n">geometric_calibration</span><span class="p">[</span><span class="s1">&#39;BORDERS&#39;</span><span class="p">],</span>
                <span class="s1">&#39;MASKS&#39;</span><span class="p">:</span> <span class="n">geometric_calibration</span><span class="p">[</span><span class="s1">&#39;MASKS&#39;</span><span class="p">],</span>
                <span class="s1">&#39;SPECSHIFT&#39;</span><span class="p">:</span> <span class="n">geometric_calibration</span><span class="p">[</span><span class="s1">&#39;SPECSHIFT&#39;</span><span class="p">]}</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">geo_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;MASKS&#39;</span><span class="p">:</span>
            <span class="c1"># This is the listed data</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">geo_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
                <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geo_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">geo_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fitsData</span><span class="o">.</span><span class="n">file_list</span><span class="p">),</span>
               <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">geo_dict</span><span class="p">),</span>
               <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">knife_type</span><span class="p">),</span>
               <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">outdir</span><span class="p">))</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">geo_helper</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="c1"># Save file showing that the (lengthy) corrections have been applied</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_geo_done&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">knife_type</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Geometric corrections applied on </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()))</span></div>

<div class="viewcode-block" id="geo_helper"><a class="viewcode-back" href="../../api/DLNIRSP_Pipeline.IFUCalibration.geo_helper.html#DLNIRSP_Pipeline.IFUCalibration.geo_helper">[docs]</a><span class="k">def</span> <span class="nf">geo_helper</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">geometric_calibration</span><span class="p">,</span> <span class="n">knife_type</span><span class="p">,</span> <span class="n">outdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Actually apply the geometric correction and save the corrected file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : str</span>
<span class="sd">        The name of the file to correct</span>

<span class="sd">    geometric_calibration : dict</span>
<span class="sd">        Geometric Calibration parameters</span>

<span class="sd">    knife_type : str</span>
<span class="sd">        Either &#39;xknife&#39; or &#39;yknife&#39;</span>

<span class="sd">    outdir : str</span>
<span class="sd">        The directory in which to save corrected images</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hdl</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">hdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="k">if</span> <span class="n">knife_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DLN__031&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">knife_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DLN__035&#39;</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">_step_</span><span class="si">{:04n}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">knife_type</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> step </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> -&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">(),</span> <span class="n">knife_type</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="n">slit_list</span> <span class="o">=</span> <span class="n">generic</span><span class="o">.</span><span class="n">apply_geo_corr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">geometric_calibration</span><span class="p">)</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">slit_list</span><span class="p">)</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
    <span class="n">ph</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">ph</span><span class="o">.</span><span class="n">data</span>
    <span class="k">del</span> <span class="n">stack</span>
    <span class="k">del</span> <span class="n">ph</span>
    <span class="k">del</span> <span class="n">hdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">del</span> <span class="n">hdl</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">slit_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">slit_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">slit_list</span></div>

<div class="viewcode-block" id="find_positions"><a class="viewcode-back" href="../../api/DLNIRSP_Pipeline.IFUCalibration.find_positions.html#DLNIRSP_Pipeline.IFUCalibration.find_positions">[docs]</a><span class="k">def</span> <span class="nf">find_positions</span><span class="p">(</span><span class="n">fitsData</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find a single axis (x|y) of the IFU FOV position of each spatial pixel in the input data</span>

<span class="sd">    The input data must represent an ordered sequence of knife-edge (scan mirror) steps across the face of the IFU along</span>
<span class="sd">    a single axis. The positions found by this function will correspond to the direction of knife-edge motion.</span>

<span class="sd">    The algorithm is as follows:</span>

<span class="sd">    1. Assign each scan step a real position in the FOV</span>

<span class="sd">    2. Collapse all steps along the wavelength dimension</span>

<span class="sd">    3. Filter out positions with no/low signal</span>

<span class="sd">    4. For each step:</span>
<span class="sd">       1. Compute the gradient of signal with step</span>
<span class="sd">       2. Fit the peak in gradient</span>
<span class="sd">       3. Compute the real position associated with the scan step at the peak gradient</span>

<span class="sd">    The peak gradient of each spatial position corresponds to the moment the knife-edge passes in front of that</span>
<span class="sd">    particular fiber. Thus, these peaks show the real spatial location of each slit position.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsData : `Data.FitsData`</span>
<span class="sd">        Each step of the knife-edge scan should be a separate data_hdu and they should be in order</span>

<span class="sd">    thresh : float</span>
<span class="sd">        A number used to reject slit positions with low/no signal</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `numpy.ndarray`</span>
<span class="sd">        The real, physical location (along the scan dimension) for each slit position</span>

<span class="sd">    `numpy.ndarray`</span>
<span class="sd">        Array of pixel locations of the slit locations with good data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fitsData</span><span class="o">.</span><span class="n">dataset_ID</span> <span class="o">==</span> <span class="s1">&#39;xknife&#39;</span><span class="p">:</span>
        <span class="n">step0</span> <span class="o">=</span> <span class="n">fitsData</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;DLN__029&#39;</span><span class="p">]</span>
        <span class="n">dsteps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DLN__030&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">fitsData</span><span class="o">.</span><span class="n">data_hdus</span><span class="p">])</span>
        <span class="n">stepnums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DLN__031&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">fitsData</span><span class="o">.</span><span class="n">data_hdus</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">fitsData</span><span class="o">.</span><span class="n">dataset_ID</span> <span class="o">==</span> <span class="s1">&#39;yknife&#39;</span><span class="p">:</span>
        <span class="n">step0</span> <span class="o">=</span> <span class="n">fitsData</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;DLN__033&#39;</span><span class="p">]</span>
        <span class="n">dsteps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DLN__034&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">fitsData</span><span class="o">.</span><span class="n">data_hdus</span><span class="p">])</span>
        <span class="n">stepnums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DLN__035&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">fitsData</span><span class="o">.</span><span class="n">data_hdus</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Hmm, dataset ID is not xknife or yknife. This shouldn&#39;t happen&quot;</span><span class="p">)</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dsteps</span><span class="p">)</span> <span class="o">+</span> <span class="n">step0</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: constructing arrays&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">()))</span>
    <span class="n">da_data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">fitsData</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">maxes</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">da_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">da_mask</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">maxes</span> <span class="o">/</span> <span class="n">da</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">maxes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: computing arrays&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">()))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">da_data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">da_mask</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">fpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: fitting light curve peaks&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">()))</span>
    <span class="n">avg_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dsteps</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mask</span><span class="p">:</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">lc</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">a0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">grad</span><span class="p">[</span><span class="n">a0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">a0</span><span class="p">],</span> <span class="n">avg_step</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pf</span><span class="p">,</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">p0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: encountered fitting error in spatial pixel </span><span class="si">{}</span><span class="s1">, continuing&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">(),</span> <span class="n">i</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">fpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">del</span> <span class="n">data</span>

    <span class="k">return</span> <span class="n">fpos</span><span class="p">,</span> <span class="n">mask</span></div>

<div class="viewcode-block" id="gauss"><a class="viewcode-back" href="../../api/DLNIRSP_Pipeline.IFUCalibration.gauss.html#DLNIRSP_Pipeline.IFUCalibration.gauss">[docs]</a><span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">off</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gaussian function for use in fitting peaks in the light curves&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">off</span></div>

<div class="viewcode-block" id="do_all"><a class="viewcode-back" href="../../api/DLNIRSP_Pipeline.IFUCalibration.do_all.html#DLNIRSP_Pipeline.IFUCalibration.do_all">[docs]</a><span class="k">def</span> <span class="nf">do_all</span><span class="p">(</span><span class="n">knife_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Super old version of main(). Don&#39;t look here&quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">AlignmentData</span><span class="p">(</span><span class="n">knife_dir</span><span class="p">,</span> <span class="s1">&#39;xknife&#39;</span><span class="p">,</span> <span class="n">maxopen</span><span class="o">=</span><span class="mi">900</span><span class="p">)</span>
    <span class="n">xpos</span><span class="p">,</span> <span class="n">xmask</span> <span class="o">=</span> <span class="n">find_positions</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="n">Y</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">AlignmentData</span><span class="p">(</span><span class="n">knife_dir</span><span class="p">,</span> <span class="s1">&#39;yknife&#39;</span><span class="p">,</span> <span class="n">maxopen</span><span class="o">=</span><span class="mi">900</span><span class="p">)</span>
    <span class="n">ypos</span><span class="p">,</span> <span class="n">ymask</span> <span class="o">=</span> <span class="n">find_positions</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="n">pp</span> <span class="o">=</span> <span class="n">PDF</span><span class="p">(</span><span class="s1">&#39;ifus.pdf&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">xpp</span> <span class="o">=</span> <span class="n">xpos</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">ypp</span> <span class="o">=</span> <span class="n">ypos</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xpp</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpp</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ypp</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">pp</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="p">)</span>

    <span class="n">pp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span></div>

<div class="viewcode-block" id="make_movie"><a class="viewcode-back" href="../../api/DLNIRSP_Pipeline.IFUCalibration.make_movie.html#DLNIRSP_Pipeline.IFUCalibration.make_movie">[docs]</a><span class="k">def</span> <span class="nf">make_movie</span><span class="p">(</span><span class="n">fitsData</span><span class="p">,</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quick little script I made for showing the knife edge move across the IFU&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.animation</span> <span class="k">as</span> <span class="nn">animation</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="k">import</span> <span class="n">Ellipse</span>
    <span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="k">import</span> <span class="n">PatchCollection</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">ffWriter</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s1">&#39;ffmpeg&#39;</span><span class="p">]</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">ffWriter</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

    <span class="n">numframes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fitsData</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ellipse</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">)]</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">PatchCollection</span><span class="p">(</span><span class="n">patches</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;gnuplot2&#39;</span><span class="p">),</span>
                                 <span class="n">norm</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">6000</span><span class="p">),</span>
                                 <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">writer</span><span class="o">.</span><span class="n">saving</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s1">&#39;test.mp4&#39;</span><span class="p">,</span> <span class="n">numframes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numframes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># ax.clear()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fitsData</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># grid = spi.griddata((xpp, ypp), data, (xg, yg), method=&#39;nearest&#39;)</span>
            <span class="c1"># ax.imshow(grid, aspect=&#39;equal&#39;)</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">2.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
            <span class="c1"># ax.figure.show()</span>
            <span class="c1"># input(&#39;asd&#39;)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">numframes</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;half.pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">grab_frame</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">data</span></div>

</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <div class="left-footer">
         &copy; 2019, Arthur Eigenbrot
       <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" /></a>
    </div>
   
    <div class="right-footer">
      Last updated on 27 Sep 2019.
    </div>
    <div class="centre-footer">
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0
    </div>
  </div>
</footer>
  </body>
</html>